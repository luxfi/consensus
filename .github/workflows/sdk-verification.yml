name: SDK Verification Matrix

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # Python SDK - ONLY complete implementation
  python-sdk:
    name: Python SDK (Production Ready)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          cd pkg/python
          pip install -e .
          pip install pytest pytest-cov

      - name: Run comprehensive tests
        run: |
          cd pkg/python
          pytest test_consensus_comprehensive.py -v --cov=. --cov-report=term

      - name: Verify consensus behavior (not just APIs)
        run: |
          cd pkg/python
          pytest test_consensus_comprehensive.py::TestConsensusCore -v

      - name: Benchmark (real workload)
        run: |
          cd pkg/python
          python benchmark_cpu_standalone.py

  # Go SDK - Reference with stub engines
  go-sdk:
    name: Go SDK (Stubs + BFT)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.5'

      - name: Build all packages
        run: make all

      - name: Run all tests
        run: go test -v -race ./...

      - name: VERIFY Chain is stub (should fail if implemented)
        run: |
          # Check that Chain engine is still a stub
          lines=$(wc -l < engine/chain/engine.go)
          if [ "$lines" -gt 100 ]; then
            echo "âœ… Chain engine implemented! Remove this check."
            exit 0
          else
            echo "âš ï¸  Chain engine is still a stub ($lines lines)"
            exit 0
          fi

      - name: VERIFY DAG is stub (should fail if implemented)
        run: |
          # Check that DAG engine is still a stub
          lines=$(wc -l < engine/dag/engine.go)
          if [ "$lines" -gt 100 ]; then
            echo "âœ… DAG engine implemented! Remove this check."
            exit 0
          else
            echo "âš ï¸  DAG engine is still a stub ($lines lines)"
            exit 0
          fi

      - name: VERIFY PQ uses mock certificates (should fail if real)
        run: |
          # Check if PQ still uses mock certificates
          if grep -q "mock-bls-aggregate" engine/pq/consensus.go; then
            echo "âš ï¸  PQ engine still uses mock certificates"
            exit 0
          else
            echo "âœ… PQ engine has real certificates! Remove this check."
            exit 0
          fi

      - name: Test BFT (only real consensus)
        run: go test -v ./engine/bft/

      - name: Coverage report
        run: |
          go test -coverprofile=coverage.out ./...
          go tool cover -func=coverage.out

  # C SDK - Data structures only
  c-sdk:
    name: C SDK (Data Structures)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Build C SDK
        run: |
          cd pkg/c
          make clean
          make all

      - name: Run tests
        run: |
          cd pkg/c
          make test

      - name: VERIFY no real consensus (expect data structures only)
        run: |
          cd pkg/c
          # Check that all 3 types use same struct
          if grep -q "typedef struct consensus_engine" src/consensus_engine.c; then
            echo "âš ï¸  Chain/DAG/PQ share same implementation (data structures only)"
            exit 0
          fi

      - name: Benchmark (measure data structure ops, not consensus)
        run: |
          cd pkg/c
          ./build/benchmark

  # Rust SDK - FFI wrapper
  rust-sdk:
    name: Rust SDK (FFI Wrapper)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build C library (Rust depends on it)
        run: |
          cd pkg/c
          make clean
          make all

      - name: Build Rust SDK
        run: |
          cd pkg/rust
          cargo build --release

      - name: Run tests
        run: |
          cd pkg/rust
          cargo test --release

      - name: VERIFY FFI to C (not native implementation)
        run: |
          cd pkg/rust
          if grep -q "lux_consensus_process_vote" src/lib.rs; then
            echo "âš ï¸  Rust SDK is FFI wrapper to C (inherits C limitations)"
            exit 0
          fi

      - name: Benchmark FFI overhead
        run: |
          cd pkg/rust
          cargo bench --bench consensus_bench 2>&1 | tee benchmark_output.txt

          # Check for impossible performance claims
          if grep -q "votes/sec.*[0-9][0-9]M" benchmark_output.txt; then
            echo "WARNING - Benchmark shows >10M votes/sec but C library is 21K/sec"
            echo "This is physically impossible via FFI - investigate measurement"
          fi

  # C++ SDK - Snowball only
  cpp-sdk:
    name: C++ SDK (Snowball Only)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libgtest-dev

      - name: Build C++ SDK
        run: |
          cd pkg/cpp
          mkdir -p build
          cd build
          cmake ..
          make

      - name: Run tests
        run: |
          cd pkg/cpp/build
          ctest --output-on-failure

      - name: VERIFY only Snowball implemented
        run: |
          cd pkg/cpp
          # Check that Chain/DAG/PQ return nullptr
          if grep -q "return nullptr" tests/test_proven_features.cpp; then
            echo "âš ï¸  Only Snowball implemented, Chain/DAG/PQ are stubs"
            exit 0
          fi

  # Documentation validation
  documentation-check:
    name: Validate Documentation Matches Reality
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for misleading claims
        run: |
          echo "Checking documentation for accuracy..."

          # Check if docs claim "multi-language native implementations"
          if grep -r "native implementations" docs/; then
            echo "âš ï¸  WARNING: Docs claim 'native implementations' but only Python is native"
          fi

          # Check if docs claim Chain/DAG are production ready
          if grep -r "production ready.*Chain" docs/ || grep -r "production ready.*DAG" docs/; then
            echo "âš ï¸  WARNING: Docs claim Chain/DAG are production ready but they're stubs"
          fi

          # Check SDK comparison table
          if [ -f "docs/content/docs/sdk/comparison.mdx" ]; then
            echo "âœ… SDK comparison documentation found"
          else
            echo "âš ï¸  No SDK comparison table - should document reality vs claims"
          fi

      - name: Verify audit reports exist
        run: |
          test -f ALL_SDK_REALITY_CHECK.md || echo "âš ï¸  Missing: ALL_SDK_REALITY_CHECK.md"
          test -f GO_SDK_VERIFICATION_REPORT.md || echo "âš ï¸  Missing: GO_SDK_VERIFICATION_REPORT.md"
          test -f pkg/c/TEST_RESULTS.md || echo "âš ï¸  Missing: pkg/c/TEST_RESULTS.md"
          test -f pkg/rust/TEST_REPORT.md || echo "âš ï¸  Missing: pkg/rust/TEST_REPORT.md"
          test -f PQ_VERIFICATION_REPORT.md || echo "âš ï¸  Missing: PQ_VERIFICATION_REPORT.md"

      - name: Check LLM.md is updated
        run: |
          if grep -q "CRITICAL SDK AUDIT" LLM.md; then
            echo "âœ… LLM.md documents SDK audit findings"
          else
            echo "âš ï¸  LLM.md missing SDK audit section (optional)"
          fi

  # Benchmark sanity checks
  benchmark-validation:
    name: Validate Benchmarks Are Real
    runs-on: ubuntu-latest
    needs: [python-sdk, c-sdk, rust-sdk]

    steps:
      - uses: actions/checkout@v4

      - name: Check for benchmark bugs
        run: |
          echo "Validating benchmark code for common bugs..."

          # Check Rust benchmarks for u8 overflow bug
          if grep -r "(0..size as u8)" pkg/rust/benches/; then
            echo "âŒ CRITICAL: Rust benchmarks have u8 overflow bug!"
            echo "   This caps iterations at 255 instead of requested size"
            exit 1
          else
            echo "âœ… Rust benchmarks don't have u8 overflow bug"
          fi

          # Check for impossible FFI performance claims
          echo "âš ï¸  Note: Rust FFI cannot be faster than C it calls (21K votes/sec)"
          echo "âš ï¸  Any Rust benchmark >100K votes/sec is measuring wrong thing"

      - name: Validate benchmark methodology
        run: |
          echo "Checking benchmark methodologies..."

          # Python should test real consensus workload
          if grep -q "is_accepted" pkg/python/benchmark_cpu_standalone.py; then
            echo "âœ… Python benchmarks test real consensus behavior"
          fi

          # Check if Go benchmarks measure stubs
          if [ $(wc -l < engine/chain/engine.go) -lt 100 ]; then
            echo "âš ï¸  WARNING: Go Chain benchmarks measure stub (invalid results)"
          fi

  # Final summary
  summary:
    name: SDK Audit Summary
    runs-on: ubuntu-latest
    needs: [python-sdk, go-sdk, c-sdk, rust-sdk, cpp-sdk, documentation-check, benchmark-validation]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Print SDK Status Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "            Lux Consensus SDK Status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Production Ready:"
          echo "  âœ… Python SDK    - All consensus types (Chain, DAG, PQ)"
          echo "  âœ… Go BFT       - Byzantine fault tolerance"
          echo "  âœ… Go AI        - Shared hallucinations"
          echo ""
          echo "Partial/Limited:"
          echo "  âš ï¸  Go Chain     - STUB (69 LOC, returns nil)"
          echo "  âš ï¸  Go DAG       - STUB (83 LOC, returns nil)"
          echo "  âš ï¸  Go PQ        - Mock certificates (not production)"
          echo "  âš ï¸  C SDK        - Data structures only (no consensus)"
          echo "  âš ï¸  Rust SDK     - FFI wrapper (inherits C limits)"
          echo "  âš ï¸  C++ SDK      - Snowball only (others stubbed)"
          echo ""
          echo "Documentation:"
          echo "  ðŸ“„ ALL_SDK_REALITY_CHECK.md - Complete audit"
          echo "  ðŸ“„ GO_SDK_VERIFICATION_REPORT.md - Go analysis"
          echo "  ðŸ“„ pkg/c/TEST_RESULTS.md - C analysis"
          echo "  ðŸ“„ pkg/rust/TEST_REPORT.md - Rust analysis"
          echo "  ðŸ“„ PQ_VERIFICATION_REPORT.md - PQ analysis"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
